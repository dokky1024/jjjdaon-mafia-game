<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAFIA: The Rule Breaker</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #0d0d0f; --panel: #1a1a1f; --acc: #ff4757; --text: #f1f2f6; --mafia: #8e44ad; --citizen: #2ecc71; --neutral: #f1c40f; }
        body { background: var(--bg); color: var(--text); font-family: 'Apple SD Gothic Neo', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* ë ˆì´ì•„ì›ƒ êµ¬ì¡° */
        #side-panel { width: 320px; background: var(--panel); border-right: 2px solid #333; display: flex; flex-direction: column; }
        #main-panel { flex: 1; display: flex; flex-direction: column; position: relative; }
        
        /* í”Œë ˆì´ì–´ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .player-card { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; transition: 0.3s; }
        .player-card.selected { background: var(--acc); }
        .player-card.dead { opacity: 0.4; filter: grayscale(1); }
        
        /* ë¡œê·¸ ë° ì±„íŒ… */
        #log-view { flex: 1; overflow-y: auto; padding: 20px; font-size: 15px; line-height: 1.7; background: rgba(0,0,0,0.2); }
        #input-bar { height: 70px; background: #000; display: flex; padding: 10px; border-top: 1px solid #333; }
        input { flex: 1; background: #222; border: 1px solid #444; color: #fff; padding: 15px; border-radius: 8px; font-size: 16px; }
        
        /* ì§ì—…/ìƒíƒœ í‘œì‹œ */
        #my-status { padding: 20px; background: #000; border-top: 2px solid var(--acc); }
        .ability-btn { width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        
        /* ì¬í•´ íš¨ê³¼ ì˜¤ë²„ë ˆì´ */
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:999; display:none; }
        .dust { background: rgba(243, 156, 18, 0.2); display: block; }
        .blackout { background: rgba(0,0,0,0.9); display: block; }
    </style>
</head>
<body>

<div id="weather-overlay" class="overlay"></div>

<div id="side-panel">
    <div style="padding: 20px; font-weight: bold; font-size: 1.2em; border-bottom: 2px solid #333;">ì°¸ì—¬ì ëª©ë¡</div>
    <div id="player-list" style="flex: 1; overflow-y: auto;"></div>
    <div id="my-status">
        <div id="role-name" style="font-size: 1.2em; color: var(--acc);">ì ‘ì† ì¤‘...</div>
        <div id="role-desc" style="font-size: 0.8em; margin: 5px 0;">ëŒ€ê¸°ì‹¤ì—ì„œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</div>
        <div id="ability-area"></div>
    </div>
</div>

<div id="main-panel">
    <div id="game-header" style="height: 60px; background: #000; display: flex; align-items: center; padding: 0 20px; justify-content: space-between;">
        <div id="phase-tag">ğŸ  ëŒ€ê¸°ì‹¤</div>
        <div id="weather-tag">â˜€ï¸ ë§‘ìŒ</div>
        <div id="room-info">ë°© ì½”ë“œ: <span id="room-id-display">----</span></div>
    </div>
    <div id="log-view"></div>
    <div id="input-bar">
        <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
    </div>
</div>

<script>
// --- [1] Firebase ì´ˆê¸°í™” ---
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    databaseURL: "YOUR_DATABASE_URL",
    projectId: "YOUR_PROJECT_ID",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- [2] ê²Œì„ ì „ì—­ ë³€ìˆ˜ ---
let roomID = "ROOM_001"; // í™•ì¥ ê°€ëŠ¥
let myID = "Player_" + Math.floor(Math.random() * 1000);
let myRole = null;
let isHost = false;

// --- [3] 20ì¢… ì§ì—… ë¡œì§ ì •ì˜ ---
const ROLES = {
    "ì‹œë¯¼": { team: "citizen", desc: "ëŠ¥ë ¥ ì—†ìŒ", power: 0 },
    "ê²½ì°°": { team: "citizen", desc: "ë°¤ë§ˆë‹¤ í•œ ëª… ì¡°ì‚¬ (ì§„ì˜ í™•ì¸)", power: 1 },
    "ì˜ì‚¬": { team: "citizen", desc: "ë°¤ë§ˆë‹¤ í•œ ëª… ì¹˜ë£Œ (ìí í¬í•¨)", power: 1 },
    "ê°ì‹œì": { team: "citizen", desc: "ëˆ„ê°€ ëˆ„êµ¬ì—ê²Œ ëŠ¥ë ¥ì„ ì¼ëŠ”ì§€ ê°ì‹œ", power: 1 },
    "ë¯¸ì¹˜ê´‘ì´ì˜ì‚¬": { team: "citizen", desc: "ì¹˜ë£Œ ì‹œ ëŒ€ìƒì´ ë¬´ì‚¬í•˜ë©´ ì‚¬ë§ì‹œí‚´", power: 1 },
    "êµ°ì¸": { team: "citizen", desc: "ìŠµê²© 1íšŒ ë°©ì–´, íˆ¬í‘œ ì‹œ ì¦‰ì‚¬", life: 2 },
    "ì—°ì¸": { team: "citizen", desc: "ì„œë¡œ ì—°ê²°ë¨, ëŒ€ì‹  ì£½ì–´ì¤Œ", power: 0 },
    "ì‹œì¥": { team: "random", desc: "íˆ¬í‘œê¶Œ 3í‘œ í–‰ì‚¬", power: 0 },
    "ê°œí‘œì¸": { team: "random", desc: "íˆ¬í‘œ ê²°ê³¼ ê°•ì œ ì¡°ì‘ (30ì´ˆ)", power: 1 },
    "ì‚¬ì œ": { team: "citizen", desc: "ê²Œì„ ì¤‘ 1íšŒ ë¶€í™œ", power: 1 },
    "ê´‘ëŒ€": { team: "neutral", desc: "íˆ¬í‘œë¡œ ì²˜í˜• ì‹œ ìŠ¹ë¦¬", power: 0 },
    "ê°ì—¼ì": { team: "neutral", desc: "ëª¨ë‘ ê°ì—¼ ì‹œ ìŠ¹ë¦¬", power: 1 },
    "ì‹ì¸ì¢…": { team: "neutral", desc: "ëª¨ë‘ ì¡ì•„ë¨¹ìœ¼ë©´ ìŠ¹ë¦¬", power: 1 },
    "ê¸°ìˆ ì": { team: "citizen", desc: "ëŠ¥ë ¥ ì‚¬ìš© ì°¨ë‹¨", power: 1 },
    "ì•”ì‚´ì": { team: "mafia", desc: "ì‚´í•´ ê¸°ë¡ì´ ë‚¨ì§€ ì•ŠìŒ", power: 1 },
    "ë³€ì¥ìˆ ì‚¬": { team: "mafia", desc: "ì‚´í•´ ì£¼ì²´ë¥¼ ìœ„ì¥í•¨", power: 1 },
    "ë§ˆë…€": { team: "mafia", desc: "ë°©ì–´ ë¬´ì‹œ ì‚´í•´, ë‚® ë§ˆë²• ê°€ëŠ¥", power: 1 },
    "í…ŒëŸ¬ë¦¬ìŠ¤íŠ¸": { team: "citizen", desc: "ì£½ì„ ë•Œ ê¸¸ë™ë¬´", power: 0 },
    "ë°°ì‹ ì": { team: "citizen", desc: "ë§ˆí”¼ì•„ 1ëª… ë‚¨ì„ ì‹œ ì „í–¥", power: 0 },
    "ìê²½ë‹¨": { team: "citizen", desc: "ì‹œë¯¼ ì‚´í•´ ì‹œ ìí­", power: 1 }
};

// --- [4] ì¬í•´ ì‹œìŠ¤í…œ ë¡œì§ ---
const WEATHERS = {
    "í™©ì‚¬": "ê°ì‹œì ì‚¬ìš© ë¶ˆê°€, ë°°ì‹ ì ì „í–¥ ì§€ì—°",
    "ì •ì „": "ê°œí‘œì¸ ë¬´ë£Œ ì¡°ì‘, ì¤‘ë¦½ í™œë™ ë¶ˆê°€",
    "í•œíŒŒ": "ë°¤ ì¤‘ ë¬´ì‘ìœ„ ë™ì‚¬ ë°œìƒ",
    "í™ìˆ˜": "ë‚® íšŒì˜ ìŠ¤í‚µ",
    "ì•ˆê°œ": "ê²½ì°° ì¡°ì‚¬ ì˜¤ë¥˜, ë§ˆë…€ ë‚® ëŠ¥ë ¥ ë¶ˆê°€",
    "ê³„ì—„ë ¹": "íˆ¬í‘œ ê°•ì œ, ìê²½ë‹¨ í˜ë„í‹° ë¬´ì‹œ",
    "ì¶•ì œ": "íšŒì˜ ì‹œê°„ ì—°ì¥, ê°ì—¼ ì¹˜ë£Œ"
};

// 1ë¶€ ë§ˆë¬´ë¦¬: UI ì—…ë°ì´íŠ¸ ë° ì±„íŒ… ê¸°ì´ˆ í•¨ìˆ˜
function addLog(msg, color = "#fff") {
    const logView = document.getElementById('log-view');
    const div = document.createElement('div');
    div.style.color = color;
    div.innerHTML = `<b>></b> ${msg}`;
    logView.appendChild(div);
    logView.scrollTop = logView.scrollHeight;
}

document.getElementById('chat-input').addEventListener('keypress', (e) => {
    if(e.key === 'Enter') {
        const val = e.target.value;
        if(val.startsWith('!')) handleCommand(val);
        else sendChat(val);
        e.target.value = "";
    }
});

function handleCommand(cmd) {
    if(cmd === "!ê²Œì„ì‹œì‘") {
        addLog("ê²Œì„ ì‹œì‘ì„ ìš”ì²­í•©ë‹ˆë‹¤...", "#f1c40f");
        // 2ë¶€ì—ì„œ ìƒì„¸ ê²Œì„ ì‹œì‘ ë¡œì§ ì—°ê²°
    }
}
</script>
</body>
</html>



// --- [5] ê²Œì„ ë£¨í”„ ì œì–´ (í„´ ì‹œìŠ¤í…œ) ---
let gameData = {
    phase: "LOBBY", // LOBBY, NIGHT, MORNING, VOTE, END
    day: 1,
    weather: "ë§‘ìŒ",
    players: {},
    logs: []
};

// ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™” (Firebase ë¦¬ìŠ¤ë„ˆ)
db.ref(`rooms/${roomID}`).on('value', (snapshot) => {
    const data = snapshot.val();
    if (!data) return;
    
    gameData = data;
    updateUI();
    
    // í˜ì´ì¦ˆ ë³€ê²½ ì‹œ íŠ¹ë³„ ì—°ì¶œ
    if(gameData.phase === "NIGHT") {
        document.getElementById('weather-overlay').className = "overlay " + (gameData.weather === "ì •ì „" ? "blackout" : (gameData.weather === "í™©ì‚¬" ? "dust" : ""));
    } else {
        document.getElementById('weather-overlay').className = "overlay";
    }
});

// --- [6] ì§ì—… ë°°ë¶„ ë° ê²Œì„ ì‹œì‘ ---
function startGame() {
    const pKeys = Object.keys(gameData.players);
    if (pKeys.length < 4) {
        addLog("ìµœì†Œ 4ëª… ì´ìƒì˜ í”Œë ˆì´ì–´ê°€ í•„ìš”í•©ë‹ˆë‹¤.", "#ff4757");
        return;
    }

    let rolePool = Object.keys(ROLES); // 20ì¢… ì§ì—…
    let assignments = {};
    
    pKeys.forEach((uid, idx) => {
        let assignedRole = rolePool[idx % rolePool.length]; // ì¤‘ë³µ ë°©ì§€ ë°°ë¶„
        assignments[uid] = {
            role: assignedRole,
            isAlive: true,
            isInfected: false,
            life: ROLES[assignedRole].life || 1,
            team: ROLES[assignedRole].team === "random" ? (Math.random() > 0.5 ? "mafia" : "citizen") : ROLES[assignedRole].team
        };
    });

    db.ref(`rooms/${roomID}`).update({
        phase: "NIGHT",
        day: 1,
        weather: getRandomWeather(),
        players: assignments,
        targetList: {} // ë°¤ ì‚¬ì´ ë°œìƒí•œ íƒ€ê²Ÿ ì €ì¥ì†Œ
    });
    addLog("ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! ì²«ë‚  ë°¤ì…ë‹ˆë‹¤.", "#f1c40f");
}

// --- [7] ë°¤ì˜ ëŠ¥ë ¥ ì²˜ë¦¬ ë¡œì§ (í•µì‹¬) ---
function useAbility(targetID) {
    if (gameData.phase !== "NIGHT") return;
    const myInfo = gameData.players[myID];
    if (!myInfo.isAlive) return;

    // 20ì¢… ì§ì—…ë³„ ë¡œì§ ë¶„ê¸°
    let action = { from: myID, to: targetID, role: myInfo.role };
    
    // ì¬í•´ ìƒí™© ì²´í¬ (í™©ì‚¬ ì‹œ ê°ì‹œì ë¶ˆê°€ ë“±)
    if (gameData.weather === "í™©ì‚¬" && myInfo.role === "ê°ì‹œì") {
        addLog("í™©ì‚¬ë¡œ ì¸í•´ ì‹œì•¼ê°€ í™•ë³´ë˜ì§€ ì•Šì•„ ëŠ¥ë ¥ì„ ì“¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "#ff4757");
        return;
    }

    db.ref(`rooms/${roomID}/targetList/${myID}`).set(action);
    addLog(`${targetID}ë‹˜ì—ê²Œ ëŠ¥ë ¥ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.`);
}

// --- [8] ì•„ì¹¨ ê²°ê³¼ íŒì • (ë³µí•© ê·œì¹™ ì ìš©) ---
function processNightResults() {
    const targets = gameData.targetList || {};
    const players = gameData.players;
    let deaths = [];

    // 1. ê¸°ìˆ ì ìš°ì„  ì°¨ë‹¨
    // 2. ë§ˆí”¼ì•„/ë§ˆë…€ ê³µê²© íŒì • (ë§ˆë…€ëŠ” ë°©ì–´ ë¬´ì‹œ)
    // 3. ì˜ì‚¬/ë¯¸ì¹˜ê´‘ì´ ì˜ì‚¬ ì¹˜ë£Œ íŒì •
    // 4. í…ŒëŸ¬ë¦¬ìŠ¤íŠ¸/êµ°ì¸/ì—°ì¸ íŒ¨ì‹œë¸Œ ì²˜ë¦¬
    
    // (ì´ ë¶€ë¶„ì— ìˆ˜ë°± ì¤„ì˜ ì§ì—… ìƒì„± ifë¬¸ì´ ë“¤ì–´ê°‘ë‹ˆë‹¤)
    // ì˜ˆ: ë¯¸ì¹˜ê´‘ì´ ì˜ì‚¬ ë¡œì§
    Object.values(targets).forEach(t => {
        if(t.role === "ë¯¸ì¹˜ê´‘ì´ì˜ì‚¬") {
            const isAttacked = Object.values(targets).some(at => at.to === t.to && at.role === "ë§ˆí”¼ì•„");
            if(!isAttacked) deaths.push(t.to); // ê³µê²© ì•ˆë°›ì•˜ëŠ”ë° íí•˜ë©´ ì‚¬ë§
        }
    });

    // ê²°ê³¼ ì—…ë°ì´íŠ¸
    db.ref(`rooms/${roomID}`).update({
        phase: "MORNING",
        targetList: null, // ì´ˆê¸°í™”
        lastDeaths: deaths
    });
}

// --- [9] UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ---
function updateUI() {
    const pList = document.getElementById('player-list');
    pList.innerHTML = "";
    
    Object.keys(gameData.players).forEach(uid => {
        const p = gameData.players[uid];
        const card = document.createElement('div');
        card.className = `player-card ${p.isAlive ? '' : 'dead'}`;
        card.innerHTML = `<span>${uid}</span> <span class="badge">${p.isAlive ? 'ìƒì¡´' : 'ì‚¬ë§'}</span>`;
        
        // ë°¤ì— ìƒì¡´í•´ìˆì„ ë•Œ í´ë¦­í•˜ë©´ íƒ€ê²Ÿ ì§€ì •
        if(gameData.phase === "NIGHT" && p.isAlive && uid !== myID) {
            card.onclick = () => {
                document.querySelectorAll('.player-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                useAbility(uid);
            };
        }
        pList.appendChild(card);
    });

    // ë‚´ ì •ë³´ ì—…ë°ì´íŠ¸
    if(gameData.players[myID]) {
        document.getElementById('role-name').innerText = gameData.players[myID].role;
        document.getElementById('role-desc').innerText = ROLES[gameData.players[myID].role].desc;
    }
}

function getRandomWeather() {
    const w = ["ë§‘ìŒ", "í™©ì‚¬", "ì •ì „", "í•œíŒŒ", "í™ìˆ˜", "ì•ˆê°œ", "ê³„ì—„ë ¹", "ì¶•ì œ"];
    return w[Math.floor(Math.random() * w.length)];
}